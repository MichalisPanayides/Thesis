\subsubsection{Waiting time}\label{sec:waiting_time}
Waiting time is the amount of time that patients wait in waiting zone 1 before
they receive their service.
For a given set of parameters there are three different performance measures
around the mean waiting time that need to be considered.
The mean waiting time of type 1 individuals, the mean waiting time of type 2
individuals, and the overall mean waiting time.

\paragraph{Recursive approach}\label{sec:recursive_waiting_time}

The first approach to be considered is a recursive approach to getting the
mean waiting time.
To calculate the mean waiting time of type 1 individuals one must first
identify the set of states \((u, v)\) where a wait can occur.
For this particular Markov chain, these are all states that satisfy \(v > C\)
i.e. all states where the number of individuals in the waiting zone 1 exceed
the number of servers.
The set of such states is defined as the \textit{waiting states} and can be
denoted as a subset of all the states, where:

\begin{equation} \label{eq:waiting_states}
    S_w = \{(u, v) \in S \; | \; v > C \}
\end{equation}

Moreover, another element that needs to be considered is the expected waiting
time spent in each state for type \(i\) individuals.
In order to do so a variation of the Markov model has to be considered where
arrivals are removed.
Figure \ref{fig:markov_variation_no_arrivals} shows this new Markov chain model.

\begin{figure}[h]
    \centering
    \input{chapters/03_queueing_model/img/markov_model_variation_no_arrivals.tex}
    \caption{Variation of Markov chain model where all arrivals are removed}
    \label{fig:markov_variation_no_arrivals}
\end{figure}

For this particular Markov chain variation the expected waiting time spent at
each state \((u,v)\) for type \(i\) individuals is denoted by \(c_w^i(u,v)\).
From a type 1 individual's perspective, when they arrive at the system, no
matter how many other individuals of either type arrive after them it will not
affect their own waiting time.
The desired waiting time by acquired by calculating the inverse of the sum of
the out-flow rate of that state.
Therefore by eliminating the arrival rates of both individuals, the waiting time
at each state for type 1 individuals can be expressed as:

\begin{equation}\label{eq:waiting_time_state_type_1}
    c^{(1)}_w(u,v) =
    \begin{cases}
        0, & \textbf{if } u > 0 \textbf{ and } v = T \\
        \frac{1}{\text{min}(v,C)\mu}, & \textbf{otherwise}
    \end{cases}
\end{equation}

Note here that whenever any type 1 individual is at a state \((u,v)\) where
\(u > 0\) and \(v = T\) (i.e. all states \((1,T), (2,T) \dots, (M,T)\)) the
expected waiting time is set to \(0\).
This is done to capture the trip thorough the Markov chain from the perspective
of type 1 individuals.
Meaning that individuals visit all states of the threshold column but only the
one in the first row will return a non-zero waiting time.
Additionally, in equation \ref{eq:waiting_time_state_type_1} the service rate
\(\mu\) is multiplied by the minimum of \(v\) and \(C\) since, when the system
is at a state \((u,v)\) where \(v \geq C\), the maximum out-flow service rate
of \( C \mu \) is reached.


Similarly from a type 2 individual's perspective the same logic holds.
The only difference is that type 2 individuals cannot have a waiting time when
they are blocked in waiting zone 2.
From the Markov chain model's perspective, type 2 individuals cannot have a wait
whenever they are at state \(u, v\) where \(u > 0\).
Thus, the waiting time at each state for type 2 individuals can be expressed as:

\begin{equation}\label{eq:waiting_time_state_type_2}
    c^{(2)}_w(u,v) =
    \begin{cases}
        0, & \textbf{if } u > 0 \\
        \frac{1}{\text{min}(v, C)\mu}, & \textbf{otherwise}
    \end{cases}
\end{equation}


Thus using the set of waiting states defined in \ref{eq:waiting_states} and
equations \ref{eq:waiting_time_state_type_1} and
\ref{eq:waiting_time_state_type_2} the following recursive formula can be used
to get the mean waiting time spent in each state.
The formula goes through all states from right to left recursively and adds the
total expected waiting time of all these states together until it reaches a
state that is not in the set of waiting states.
Thus, the expected waiting time of a type \(i\) individual when they arrive at
state \( (u,v) \) is given by:

\begin{equation} \label{eq:recursive_waiting_time_for_state}
    w^{(i)}(u,v) =
    \begin{cases}
        0, \hspace{4.85cm} & \textbf{if } (u,v) \notin S_w \\
        c^{(i)}_w(u,v) + w^{(i)}(u-1, v), & \textbf{if } u > 0 \textbf{ and } v = T \\
        c^{(i)}_w(u,v) + w^{(i)}(u, v-1), & \textbf{otherwise}
    \end{cases}
\end{equation}

Whenever the system is at state \((u,v)\) and an individual arrives, depending
on the type of the individual, the system will move to a different state.
The state that the Markov chain will transition to when a type \(i\) individual
arrives is defined as the \textit{arriving state} \(\mathcal{A}_i(u,v)\).
Using Figure \ref{fig:adjusted_markov_model} as reference, an arrival of a type
1 individual makes the system transition to the state on the right.
Similarly an arrival of a type 2 individual makes the system transition to the
right if the threshold hasn't been reached and transition down if the threshold
has been reached.
This can be expressed mathematically as:

\begin{equation}\label{eq:arriving_state_type_1}
    \mathcal{A}_1(u,v) = (u, v + 1)
\end{equation}
\begin{equation}\label{eq:arriving_state_type_2}
    \mathcal{A}_2(u,v) =
    \begin{cases}
        (u, v + 1), & \text{if } v < T \\
        (u + 1, v), & \text{if } v \geq T \\
    \end{cases}
\end{equation}

Additionally, there are certain states in the model where arrivals cannot occur.
A type 1 individual cannot arrive whenever the model is at any state \((u, N)\)
for all \(u\), where \(N\) is the capacity of waiting zone 1.
Therefore the set of all such states that an arrival may occur are defined as
\textit{accepting states}.
The set of accepting states for type 1 individuals is denoted as:

\begin{equation}\label{eq:accepting_states_type_1}
    S_A^{(1)} = \{(u, v) \in S \; | \; v < N \}
\end{equation}

Similarly, an arrival of a type 2 individual cannot occur whenever the model is
at state \((M, v)\) for all \(v\), where \(M\) is the capacity of waiting zone
2.
The set of accepting states for type 2 individuals is denoted as:

\begin{equation}\label{eq:accepting_states_type_2}
    S_A^{(2)} = \{(u, v) \in S \; | \; u < M \}
\end{equation}



Finally, the total mean waiting time can be calculated by summing over all
expected waiting times of accepting states multiplied by the probability of
being at that state.
The different approaches that are used to get the state probabilities are
described in Section \ref{sec:steady_state_probabilities}.
The mean waiting time in the system for type \(i\) individuals is given by:

\begin{equation}\label{eq:recursive_waiting_time_for_type_i}
    W^{(i)} = \frac{\sum_{(u,v) \in S_A^{(i)}} \pi_{(u,v)} w^{(i)}
    (\mathcal{A}_i(u,v))}{\sum_{(u,v) \in S_A^{(i)}} \pi_{(u,v)}}
\end{equation}

Consequently, using both the mean waiting time for type 1 individuals
\(W^{(1)}\) and the mean waiting time for type 2 individuals \(W^{(2)}\), the
overall mean waiting time in the system is a linear combination of the 2.
The overall waiting time can be then given by the following equation where
\(\theta_1\) and \(\theta_2\) are the coefficients of the waiting time for each
type of individual:

\begin{equation}\label{eq:overall_waiting_time_coeff}
    W = \theta_1 W^{(1)} + \theta_2 W^{(2)}
\end{equation}

The two coefficients represent the proportion of individuals of each type that
traversed through the model.
Theoretically, getting these percentages should be as straightforward as
looking at the arrival rates of each type \(\lambda_1\) and \(\lambda_2\), but
in practise if either waiting zone 1 or waiting zone 2 are full, some
individuals may become lost to the system.
Thus, one should account for the probability that an individual is lost to the
system.
This probability can be calculated by using the two sets of accepting
states \(S_A^{(2)}\) and \(S_A^{(1)}\) defined earlier in
\ref{eq:accepting_states_type_1} and \ref{eq:accepting_states_type_2}.
Let us define the probability that an individual of type \(i\) is not lost
to the system as \(P(L'_i)\):

\begin{equation*}
    P(L'_1) = \sum_{(u,v) \, \in S_A^{(1)}} \pi(u,v) \hspace{2cm}
    P(L'_2) = \sum_{(u,v) \, \in S_A^{(2)}} \pi(u,v)
\end{equation*}


Having defined these probabilities one may combine them with the arrival rates
of each individual type in such a way to get the expected proportions of type 1
and type 2 individuals in the model.

\begin{equation}
    \theta_1 = \frac{\lambda_1 P(L'_1)}{\lambda_2 P(L'_2) + \lambda_1 P(L'_1)},
    \hspace{1.5cm}
    \theta_2 = \frac{\lambda_2 P(L'_2)}{\lambda_2 P(L'_2) + \lambda_1 P(L'_1)}
\end{equation}

Thus, by using these values as the coefficient of equation
\ref{eq:overall_waiting_time_coeff}
the resultant equation can be used to get the overall waiting time.

\begin{equation}\label{eq:overall_waiting_time}
    W = \frac{\lambda_1 P(L'_1)}{\lambda_2 P(L'_2) + \lambda_1 P(L'_1)} W^{(1)}
    + \frac{\lambda_2 P(L'_2)}{\lambda_2 P(L'_2) + \lambda_1 P(L'_1)} W^{(2)}
\end{equation}


% TODO: Add python implementation for recursive approach



\paragraph{Direct approach}\label{sec:direct_waiting_time}

The direct approach uses similar concepts to the recursive approach of Section
\ref{sec:recursive_waiting_time}.
Instead of using recursion, a linear system of the set of equations generated by
equation \ref{eq:recursive_waiting_time_for_state} for every state \((u,v)\) is
solved.
The set of equations that need to be solved for individuals of type \(i\) are
all \( w^{(i)}(u, v) \) for all possible states \((u,v) \in S\).


\begin{equation*}
    w^{(i)}(u,v) =
    \begin{cases}
        0, \hspace{4.85cm} & \textbf{if } (u,v) \notin S_w \\
        c^{(i)}_w(u,v) + w^{(i)}(u-1, v), & \textbf{if } u > 0
        \textbf{ and } v = T \\
        c^{(i)}_w(u,v) + w^{(i)}(u, v-1), & \textbf{otherwise}
    \end{cases}
\end{equation*}

Consider a relatively small model where \(C=1, T=2, N=3, M=1\).
All possible equations \(w^{(i)}(u,v)\) are given by equations
\ref{eq:first_eq_of_waiting_example} - \ref{eq:last_eq_of_waiting_example}.

\begin{minipage}{0.45\textwidth}
    \begin{figure}[H]
        \centering
        \scalebox{0.65}{\input{chapters/03_queueing_model/img/example_model_1231/main.tex}}
        \caption{Markov chain example}
        \label{fig:example-algeb-waiting}
    \end{figure}
\end{minipage}
\begin{minipage}{0.5\textwidth}
    \begin{align}
        w^{(i)}(0,0) &= 0 \\
        w^{(i)}(0,1) &= 0 \\
        w^{(i)}(0,2) &= c^{(i)}_w(0,2) + w^{(i)}(0,1) \label{eq:first_eq_of_waiting_example} \\
        w^{(i)}(0,3) &= c^{(i)}_w(0,3) + w^{(i)}(0,2) \\
        w^{(i)}(1,2) &= c^{(i)}_w(1,2) + w^{(i)}(0,2) \\
        w^{(i)}(1,3) &= c^{(i)}_w(1,3) + w^{(i)}(1,2) \label{eq:last_eq_of_waiting_example}
    \end{align}
\end{minipage}

\vspace{0.5cm}

Additionally, the above equations can be transformed into a linear system of
the form \(Zx=y\) where:

\begin{equation}\label{eq:example_direct_approach_waiting_time}
    Z=
    \begin{pmatrix}
       -1 &  0 &  0 &  0 &  0 &  0 \\  %(0,0)
        0 & -1 &  0 &  0 &  0 &  0 \\  %(0,1)
        0 &  1 & -1 &  0 &  0 &  0 \\  %(0,2)
        0 &  0 &  1 & -1 &  0 &  0 \\  %(0,3)
        0 &  0 &  1 &  0 & -1 &  0 \\  %(1,2)
        0 &  0 &  0 &  0 &  1 & -1 \\  %(1,3)
    \end{pmatrix},
    x=
    \begin{pmatrix}
        w^{(i)}(0,0) \\
        w^{(i)}(0,1) \\
        w^{(i)}(0,2) \\
        w^{(i)}(0,3) \\
        w^{(i)}(1,2) \\
        w^{(i)}(1,3) \\
    \end{pmatrix},
    y=
    \begin{pmatrix}
        0 \\
        0 \\
        -c^{(i)}_w(0,2) \\
        -c^{(i)}_w(0,3) \\
        -c^{(i)}_w(1,2) \\
        -c^{(i)}_w(1,3) \\
    \end{pmatrix}
\end{equation}

A more generalised form of the equations in
\ref{eq:example_direct_approach_waiting_time} can be given for any value of
\(C,T,N,M\) by:

\begin{align}
    w^{(i)}(0, 0) &= 0 \label{eq:first_eq_of_waiting_general} \\
    w^{(i)}(0, 1) &= c^{(i)}_w(0,1) + w^{(i)}(0,0) \\
    w^{(i)}(0, 2) &= c^{(i)}_w(0,2) + w^{(i)}(0,1) \\
    & \vdots \nonumber \\
    w^{(i)}(0, T-1) &= c^{(i)}_w(0,T-1) + w^{(i)}(0,T-2) \\
    w^{(i)}(0, T) &= c^{(i)}_w(0, T) + w^{(i)}(0, T - 1) \\
    w^{(i)}(0, T + 1) =& c^{(i)}_w(0, T + 1) + w^{(i)}(0, T) \\
    w^{(i)}(0, T + 2) =& c^{(i)}_w(0, T + 2) + w^{(i)}(0, T + 1) \\
    & \vdots \nonumber \\
    w^{(i)}(0, N) =& c^{(i)}_w(0, N) + w^{(i)}(0, N - 1) \\
    w^{(i)}(1, T) =& c^{(i)}_w(1, T) + w^{(i)}(0, T) \\
    w^{(i)}(1, T + 1) =& c^{(i)}_w(1, T + 1) + w^{(i)}(1, T) \\
    & \vdots \nonumber \\
    w^{(i)}(M, N) =& c^{(i)}_w(M, N) + w^{(i)}(M, N-1)
    \label{eq:last_eq_of_waiting_general}
\end{align}

The equivalent matrix form of the linear system of equations
(\ref{eq:first_eq_of_waiting_general}) - (\ref{eq:last_eq_of_waiting_general})
is given by \(Zx=y\), where:

\newcommand{\allthedots}{\vdots & \vdots & \vdots & \ddots & \vdots & \vdots &
\vdots & \vdots & \ddots & \vdots & \vdots & \vdots & \ddots & \vdots}

\footnotesize
\begin{equation*}\label{eq:general_direct_approach_waiting_time}
    Z =
    \begin{pmatrix}
        -1 &  0 &  0 & \dots &  0 &  0 &  0 &  0 & \dots &  0 &  0 &  0 & \dots &  0 \\    %(0, 0)
         1 & -1 &  0 & \dots &  0 &  0 &  0 &  0 & \dots &  0 &  0 &  0 & \dots &  0 \\    %(0, 1)
         0 &  1 & -1 & \dots &  0 &  0 &  0 &  0 & \dots &  0 &  0 &  0 & \dots &  0 \\    %(0, 2)
         \allthedots \\
         0 &  0 &  0 & \dots & -1 &  0 &  0 &  0 & \dots &  0 &  0 &  0 & \dots &  0 \\    %(0, T-1)
         0 &  0 &  0 & \dots &  1 & -1 &  0 &  0 & \dots &  0 &  0 &  0 & \dots &  0 \\    %(0,T)
         0 &  0 &  0 & \dots &  0 &  1 & -1 &  0 & \dots &  0 &  0 &  0 & \dots &  0 \\    %(0,T+1)
         0 &  0 &  0 & \dots &  0 &  0 &  1 & -1 & \dots &  0 &  0 &  0 & \dots &  0 \\    %(0,T+2)
         \allthedots \\
         0 &  0 &  0 & \dots &  0 &  0 &  0 &  0 & \dots & -1 &  0 &  0 & \dots &  0 \\   %(0,N)
         0 &  0 &  0 & \dots &  0 &  1 &  0 &  0 & \dots &  0 & -1 &  0 & \dots &  0 \\   %(1,T)
         0 &  0 &  0 & \dots &  0 &  0 &  1 &  0 & \dots &  0 &  0 & -1 & \dots &  0 \\   %(1,T+1)
         \allthedots \\
         0 &  0 &  0 & \dots &  0 &  0 &  0 &  0 & \dots &  0 &  0 &  0 & \dots & -1 \\   %(M,N)
    \end{pmatrix}
\end{equation*}
\normalsize

\begin{equation}
    x =
    \begin{pmatrix}
        w^{(i)}(0, 0) \\
        w^{(i)}(0, 1) \\
        w^{(i)}(0, 2) \\
        \vdots \\
        w^{(i)}(0, T-1) \\
        w^{(i)}(0, T) \\
        w^{(i)}(0, T + 1) \\
        w^{(i)}(0, T + 2) \\
        \vdots \\
        w^{(i)}(0, N) \\
        w^{(i)}(1, T) \\
        w^{(i)}(1, T + 1) \\
        \vdots \\
        w^{(i)}(M, N) \\
    \end{pmatrix},
    y=
    \begin{pmatrix}
        0 \\ %new
        -c^{(i)}_w(0,1) \\ %new
        -c^{(i)}_w(0,2) \\ %new
        \vdots \\
        -c^{(i)}_w(0,T - 1) \\ %new
        -c^{(i)}_w(0,T) \\ %new
        -c^{(i)}_w(0,T+1) \\
        -c^{(i)}_w(0,T+2) \\
        \vdots \\
        -c^{(i)}_w(0,N) \\
        -c^{(i)}_w(1,T) \\
        -c^{(i)}_w(1,T+1) \\
        \vdots \\
        -c^{(i)}_w(M,N) \\
    \end{pmatrix}
\end{equation}

Thus, solving for \(x\) gets the values of all \(w^{(i)}(u,v)\) for all states
\((u,v) \in S\).
These values can then be used with equation
\ref{eq:recursive_waiting_time_for_type_i} to compute the mean waiting time for
type \(i\) individuals \(W^{(i)}\).
Now, having \(W^{(1)}\) and \(W^{(2)}\), equation \ref{eq:overall_waiting_time}
can be utilised once more to compute the overall mean waiting time for both
individual types.

% TODO: Add python implementation for direct approach


\paragraph{Closed-form approach}\label{sec:closed_form_waiting_time}

The final approach for getting the mean waiting time is to use a closed-form
approach.
This approach is an immediate simplification of the recursive approach
described in Section \ref{sec:recursive_waiting_time}.

\begin{equation} \label{eq:closed_form_waiting_type_1}
    W^{(1)} = \frac{\sum_{\substack{(u,v) \, \in S_A^{(1)} \\ v \geq C}}
    \frac{1}{C \mu} \times (v-C+1) \times \pi(u,v)}{\sum_{(u,v) \,
    \in S_A^{(1)}} \pi(u,v)}
\end{equation}

The mean waiting time of type 2 individuals:

\begin{equation}\label{eq:closed_form_waiting_type_2}
    W^{(2)} = \frac{\sum_{\substack{(u,v) \, \in S_A^{(2)} \\ min(v,T) \geq C}}
    \frac{1}{C \mu} \times (\min(v+1,T)-C) \times \pi(u,v)}{\sum_{(u,v) \,
    \in S_A^{(2)}} \pi(u,v)}
\end{equation}

Equation \ref{eq:overall_waiting_time} can then be used to compute the overall
mean waiting time for both types \(W\).

% TODO: Add python implementation for closed-form approach
